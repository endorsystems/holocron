---
- hosts: localhost
  become: no

  roles:
    - kewlfft.aur

  vars_files:
    - vars/main.yml

  tasks:
  - name: Install all required packages
    community.general.pacman:
        name: '{{ item }}'
        state: present
    with_items: '{{ required_packages }}'
    become: yes

#   - name: Remove depandancy issues
#     community.general.pacman:
#         name: '{{ item }}'
#         state: absent
#     with_items: '{{ remove_packages }}'

  - name: Install pikaur manager
    aur:
        name: pikaur
        state: present

  - name: Install AUR packages
    aur:
        name: '{{ item }}'
        state: present
        use: pikaur
        extra_args: '-Syyu'
    with_items: '{{ required_aur }}'

  - name: Setup nsswitch.conf
    copy:
        src: files/nsswitch.conf
        dest: /etc/nsswitch.conf
        backup: yes
    become: yes
    notify: restart_avahi
    
  - name: Setup fonts
    blockinfile:
        path: /etc/fonts/local.conf
        block: |
            <?xml version="1.0"?>
            <!DOCTYPE fontconfig SYSTEM "fonts.dtd">
            <fontconfig>
                <match>
                    <edit mode="prepend" name="family"><string>{{ sans_serif_font }}</string></edit>
                </match>
                <match target="pattern">
                    <test qual="any" name="family"><string>serif</string></test>
                    <edit name="family" mode="assign" binding="same"><string>{{ serif_font }}</string></edit>
                </match>
                <match target="pattern">
                    <test qual="any" name="family"><string>sans-serif</string></test>
                    <edit name="family" mode="assign" binding="same"><string>{{ sans_serif_font }}</string></edit>
                </match>
                <match target="pattern">
                    <test qual="any" name="family"><string>monospace</string></test>
                    <edit name="family" mode="assign" binding="same"><string>{{ monospace_font }}</string></edit>
                </match>
            </fontconfig>
        create: yes
    become: yes

  - name: Create bitmap symlinks
    file:
        src: "/etc/fonts/conf.avail/{{ item }}"
        dest: "/etc/fonts/conf.d/{{ item }}"
        state: link
    become: yes
    with_items:
        - 70-no-bitmaps.conf
        - 10-sub-pixel-rgb.conf
        - 11-lcdfilter-default.conf

  - name: Enable freetype properties
    replace:
      path: /etc/profile.d/freetype2.sh
      regexp: '^#(.*FREETYPE_PROPERTIES.*)'
      replace: '\1'
    become: yes

  - name: Enable systemd stuff
    systemd:
        name: '{{ item }}'
        state: started
        enabled: yes
    become: yes
    with_items: '{{ enabled_services }}'

  - name: User mods
    user:
        name: '{{ ansible_user_id }}'
        groups: docker
        append: yes
    become: yes

  - name: Auto connection for bluetooth
    blockinfile:
        path: /etc/pulse/default.pa
        block: |
            ### Automatically switch to newly-connected devices
            load-module module-switch-on-connect

  - name: Additional settings for bluetooth
    lineinfile:
        path: /etc/pulse/default.pa
        regexp: '^(.*load-module module-bluetooth-policy.*)$'
        backup: yes
        line: '\1 auto_switch=2'

  - name: Download dotfiles
    git:
        repo: '{{ dots_url }}'
        dest: '{{ ansible_user_dir }}/dotfiles'
        update: yes

  - name: Install dotfiles
    file:
        src: "{{ ansible_user_dir }}/dotfiles/{{ item.src }}"
        dest: "{{ ansible_user_dir }}/{{ item.dst }}"
        state: link
        force: yes
    with_items: '{{ dots_links }}'

# HANDLERS
  handlers:
    - name: restart_avahi
      ansible.builtin.service:
        name: avahi-daemon
        state: restarted
      become: yes